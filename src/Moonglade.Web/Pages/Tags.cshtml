@page "/tags"
@using System.Web
@using Moonglade.Features.Tag
@{
    ViewBag.TitlePrefix = "Tags";
    ViewBag.BodyClass = "body-tags-index bg-gray-1";
    var tags = await QueryMediator.QueryAsync(new GetTagCountListQuery());
}

@functions {
    private static string GetWeightClass(double weightPercent) =>
        weightPercent switch
        {
            >= 99 => "danger",
            >= 70 => "success",
            >= 40 => "accent",
            >= 20 => "secondary",
            _ => "outline-secondary"
        };

    private static string FormatDisplayName(string displayName) =>
        displayName?.Replace("-", " ") ?? string.Empty;
}

@section scripts {
    <script type="module" src="~/js/app/tags.mjs"></script>
}

<div class="tags-page">
    <h2 class="page-heading mb-4">
        @SharedLocalizer["Tags"]
    </h2>

    @if (tags?.Any() == true)
    {
        var tagMax = tags.Max(p => p.PostCount);
        var sortedTags = tags.Where(t => t.PostCount > 0).OrderBy(t => t.DisplayName).ToList();
        var groupedTags = sortedTags
            .GroupBy(t =>
            {
                var first = char.ToUpperInvariant(t.DisplayName[0]);
                return char.IsLetter(first) ? first.ToString() : "#";
            })
            .OrderBy(g => g.Key)
            .ToList();

        <div class="mb-3">
            <input id="tagFilter"
                   type="text"
                   class="form-control"
                   maxlength="32"
                   placeholder="@SharedLocalizer["Filter tags..."]"
                   role="search"
                   aria-label="@SharedLocalizer["Filter tags"]">
        </div>

        <div class="tag-groups">
            @foreach (var group in groupedTags)
            {
                <div class="tag-letter-group" data-letter="@group.Key">
                    <div class="tag-letter-tile">
                        <span>@group.Key</span>
                    </div>
                    <ul class="list-unstyled ul-tags mb-0" role="list">
                        @foreach (var tagItem in group)
                        {
                            var weightPercent = (double)tagItem.PostCount / tagMax * 100;
                            var weightClass = GetWeightClass(weightPercent);
                            var displayName = FormatDisplayName(tagItem.DisplayName);
                            var normalizedName = tagItem.NormalizedName?.ToLowerInvariant();

                            <li class="d-inline-block mb-2 me-2">
                                <a asp-page="/TagList"
                                   asp-route-normalizedName="@normalizedName"
                                   class="btn btn-sm btn-@weightClass"
                                   title="@string.Format(SharedLocalizer["{0} posts"], tagItem.PostCount)"
                                   aria-label="@string.Format(SharedLocalizer["View posts tagged with {0}"], displayName)">
                                    @displayName
                                </a>
                            </li>
                        }
                    </ul>
                </div>
            }
        </div>

        <div class="mt-3 text-muted small">
            @string.Format(SharedLocalizer["Showing {0} tags"], sortedTags.Count)
        </div>
    }
    else
    {
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle me-2" aria-hidden="true"></i>
            @SharedLocalizer["No Tags"]
        </div>
    }
</div>
