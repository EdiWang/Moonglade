@page "/admin/post/edit/{id:guid?}"
@inject IConfiguration Configuration

@{
    ViewBag.Title = "Edit Post";
    ViewBag.XData = "postEditor";
    ViewBag.HideAdminSidebar = true;
    ViewBag.AdminBackUrl = "javascript:history.go(-1);";
    var ec = Configuration.GetValue<EditorChoice>("Post:Editor");
}

@section scripts {
    <script src="~/lib/tagify/tagify.js"></script>
    @switch (ec)
    {
        case EditorChoice.Html:
            <script src="~/lib/tinymce/tinymce.min.js"></script>
            break;
        case EditorChoice.Markdown:
            <partial name="_MonacoLoaderScript" />
            <script src="~/js/3rd/inline-attachment.js"></script>
            <script src="~/js/3rd/monaco.inline-attachment.js"></script>
            break;
    }

    <script type="module" src="~/js/app/admin.editpost.mjs"></script>
}

@section head {
    <link href="~/lib/tagify/tagify.css" rel="stylesheet" />
}

@Html.AntiForgeryToken()

<div x-show="isLoading" class="text-muted mb-3" :class="{ 'd-flex align-items-center': isLoading }">
    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
    <span>Loading post data...</span>
</div>

<div x-show="!isLoading" x-cloak class="post-editor-container d-flex flex-column px-3 pt-2">
    <form id="post-edit-form" x-on:submit.prevent="handleSubmit">
        <div class="row g-2">
            <div class="col-md-9 col-xl-10">
                <input type="text"
                       x-model="formData.title"
                       class="form-control form-control-lg mb-1"
                       placeholder="@SharedLocalizer["Title"]"
                       required
                       maxlength="128"
                       x-on:change="onTitleChange" />

                <template x-if="editorChoice === 'html'">
                    <textarea class="post-content-textarea" x-model="formData.editorContent"></textarea>
                </template>
                <template x-if="editorChoice === 'markdown'">
                    <div>
                        <div id="markdown-content-editor" class="monaco-target overflow-y-hidden"></div>
                        <textarea class="post-content-textarea d-none" x-model="formData.editorContent"></textarea>
                        <div class="md-editor-image-upload-area text-center border-secondary-subtle p-3 mt-1">
                            Drag &amp; Drop / Paste image here to upload.
                        </div>
                    </div>
                </template>

                <div class="mt-1">
                    <div class="form-floating">
                        <textarea x-model="formData.abstract"
                                  placeholder="@SharedLocalizer["Abstract"]"
                                  class="form-control form-control-sm"
                                  maxlength="1024"
                                  required
                                  id="post-abstract"
                                  style="height: 90px"></textarea>
                        <label for="post-abstract">@SharedLocalizer["Abstract"]</label>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-xl-2">
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="input-group input-group-sm mb-2">
                            <label class="input-group-text">
                                <i class="bi-link-45deg"></i>
                            </label>
                            <input type="text"
                                   x-model="formData.slug"
                                   class="form-control form-control-sm"
                                   placeholder="Slug"
                                   spellcheck="false"
                                   required
                                   pattern="[a-z0-9\-]+"
                                   maxlength="128"
                                   x-bind:readonly="warnSlugModification && !slugUnlocked" />
                            <a x-show="warnSlugModification && !slugUnlocked"
                               x-on:click="unlockSlug"
                               class="btn btn-warning btn-sm">Modify</a>
                        </div>

                        <div class="input-group input-group-sm mb-2">
                            <label class="input-group-text">
                                <i class="bi-person"></i>
                            </label>
                            <input type="text"
                                   class="form-control form-control-sm"
                                   spellcheck="false"
                                   x-model="formData.author" />
                        </div>

                        <div class="input-group input-group-sm">
                            <label class="input-group-text">
                                <i class="bi-globe"></i>
                            </label>
                            <select class="form-select" x-model="formData.languageCode">
                                <template x-for="lang in languages" :key="lang.value">
                                    <option :value="lang.value" x-text="lang.nativeName"></option>
                                </template>
                            </select>
                        </div>
                    </div>
                    <div class="card-body border-top">
                        <div class="form-check form-switch">
                            <input type="checkbox"
                                   x-model="formData.enableComment"
                                   class="form-check-input"
                                   id="enableComment">
                            <label for="enableComment" class="form-check-label">Enable Comment</label>
                        </div>
                        <div class="form-check form-switch">
                            <input type="checkbox"
                                   x-model="formData.featured"
                                   class="form-check-input"
                                   id="featured">
                            <label for="featured" class="form-check-label">Featured</label>
                        </div>
                        <div class="form-check form-switch">
                            <input type="checkbox"
                                   x-model="formData.isOutdated"
                                   class="form-check-input"
                                   id="isOutdated">
                            <label for="isOutdated" class="form-check-label">Mark as outdated</label>
                        </div>
                    </div>
                    <div class="card-body border-top">
                        <div class="mb-1">
                            <input type="text" id="post-tags-input" placeholder="@SharedLocalizer["Tags"]" />
                        </div>

                        <div class="form-floating">
                            <textarea x-model="formData.keywords"
                                      class="form-control form-control-sm"
                                      placeholder="Keywords (split by comma ',')"
                                      id="post-keywords"></textarea>
                            <label class="form-label" for="post-keywords">Keywords (split by comma ',')</label>
                        </div>
                    </div>
                    <div class="card-body border-top">
                        <h6 class="card-subtitle mb-3 text-muted">
                            <i class="bi-folder2 me-1"></i>
                            @SharedLocalizer["Categories"]

                            <a asp-page="./Category" target="_blank" class="float-end">
                                <i class="bi-box-arrow-up-right"></i>
                            </a>
                        </h6>

                        <div class="post-editor-catlist" x-show="categories.length > 0">
                            <ul>
                                <template x-for="cat in categories" :key="cat.id">
                                    <li>
                                        <div class="form-check">
                                            <input type="checkbox"
                                                   :id="'category-' + cat.id"
                                                   :value="cat.id"
                                                   :checked="formData.selectedCatIds.includes(cat.id)"
                                                   x-on:change="toggleCategory(cat.id, $event.target.checked)"
                                                   class="form-check-input">
                                            <label :for="'category-' + cat.id" class="form-check-label" x-text="cat.displayName"></label>
                                        </div>
                                    </li>
                                </template>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-3">
            <button type="submit"
                    class="btn btn-outline-accent"
                    id="btn-save"
                    x-bind:disabled="isSaving"
                    x-on:click="submitAction = 'save'">
                <span x-show="formData.postStatus === 'Draft'" x-cloak>@SharedLocalizer["Save"]</span>
                <span x-show="formData.postStatus === 'Published' || formData.postStatus === 'Scheduled'" x-cloak>@SharedLocalizer["Update"]</span>
            </button>

            <button type="submit"
                    class="btn btn-outline-secondary"
                    id="btn-preview"
                    x-show="formData.postStatus !== 'Published'"
                    x-cloak
                    x-bind:disabled="isSaving"
                    x-on:click="submitAction = 'preview'">
                <i class="bi-eye me-1"></i>@SharedLocalizer["Preview"]
            </button>

            <button x-show="formData.postStatus !== 'Published'" x-cloak
                    type="button"
                    class="btn btn-outline-accent"
                    id="btn-publish"
                    x-bind:disabled="isSaving"
                    x-on:click="openPublishModal()">
                @SharedLocalizer["Publish"]
            </button>

            <a x-show="formData.postStatus === 'Published'"
               x-cloak
               class="unpublish-link btn btn-outline-secondary"
               data-bs-toggle="modal"
               data-bs-target="#unpublishPostModal">@SharedLocalizer["Unpublish"]</a>

            <div class="schedule-info d-inline-block text-muted ms-4" x-html="scheduleInfoHtml"></div>
        </div>

        <!-- Publish Modal -->
        <div class="modal fade" id="publishModal" tabindex="-1" role="dialog" aria-labelledby="publishModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="publishModalLabel">@SharedLocalizer["Publish"]</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="form-check form-switch mb-3">
                            <input type="checkbox"
                                   x-model="formData.feedIncluded"
                                   class="form-check-input"
                                   id="publishFeedIncluded">
                            <label for="publishFeedIncluded" class="form-check-label">Include in feed and sitemap</label>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input type="checkbox"
                                   x-model="enableSchedule"
                                   class="form-check-input"
                                   id="enableScheduleToggle">
                            <label for="enableScheduleToggle" class="form-check-label">Schedule Publish</label>
                        </div>
                        <div x-show="enableSchedule" x-cloak class="mb-2">
                            <label class="form-label">@SharedLocalizer["Set a time in your local time zone to schedule the post to be automatically published."]</label>
                            <input type="datetime-local" x-model="formData.scheduledPublishTime" class="form-control" :min="minScheduleDate" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">@SharedLocalizer["Cancel"]</button>
                        <button type="button" class="btn btn-accent" x-on:click="submitPublish">@SharedLocalizer["Submit"]</button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Unpublish Post Modal -->
    <div class="modal fade" id="unpublishPostModal" tabindex="-1" role="dialog" aria-labelledby="unpublishPostModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="unpublishPostModalLabel">@SharedLocalizer["Unpublish Post"]</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">@SharedLocalizer["Unpublishing this post will remove it from the public site and turn it into a draft. This will have impact on SEO. Please confirm."]</div>
                    <p x-text="formData.title"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">@SharedLocalizer["Cancel"]</button>
                    <a id="btn-unpublish-post" class="btn btn-danger" x-on:click="unpublishPost" data-bs-dismiss="modal">@SharedLocalizer["Confirm"]</a>
                </div>
            </div>
        </div>
    </div>
</div>