(function(n,t){"use strict";var i=function(n,t){this.settings=i.util.merge(n,i.defaults);this.editor=t;this.filenameTag="{filename}";this.lastValue=null};i.editors={};i.util={merge:function(){for(var n,t,r={},i=arguments.length-1;i>=0;i--){n=arguments[i];for(t in n)n.hasOwnProperty(t)&&(r[t]=n[t])}return r},appendInItsOwnLine:function(n,t){return(n+"\n\n[[D]]"+t).replace(/(\n{2,})\[\[D\]\]/,"\n\n").replace(/^(\n*)/,"")},insertTextAtCursor:function(t,i){var s=t.scrollTop,r=0,f=!1,u,e,o;t.selectionStart||t.selectionStart==="0"?f="ff":n.selection&&(f="ie");f==="ie"?(t.focus(),u=n.selection.createRange(),u.moveStart("character",-t.value.length),r=u.text.length):f==="ff"&&(r=t.selectionStart);e=t.value.substring(0,r);o=t.value.substring(r,t.value.length);t.value=e+i+o;r=r+i.length;f==="ie"?(t.focus(),u=n.selection.createRange(),u.moveStart("character",-t.value.length),u.moveStart("character",r),u.moveEnd("character",0),u.select()):f==="ff"&&(t.selectionStart=r,t.selectionEnd=r,t.focus());t.scrollTop=s}};i.defaults={uploadUrl:"upload_attachment.php",uploadMethod:"POST",uploadFieldName:"file",defaultExtension:"png",jsonFieldName:"filename",allowedTypes:["image/jpeg","image/png","image/jpg","image/gif"],progressText:"![Uploading file...]()",urlText:"![file]({filename})",errorText:"Error uploading file",extraParams:{},extraHeaders:{},beforeFileUpload:function(){return!0},onFileReceived:function(){},onFileUploadResponse:function(){return!0},onFileUploadError:function(){return!0},onFileUploaded:function(){}};i.prototype.uploadFile=function(n){var s=this,r=new FormData,i=new XMLHttpRequest,t=this.settings,h=t.defaultExtension||t.defualtExtension,e,o,u,f;if(typeof t.setupFormData=="function"&&t.setupFormData(r,n),n.name&&(e=n.name.match(/\.(.+)$/),e&&(h=e[1])),o="image-"+Date.now()+"."+h,typeof t.remoteFilename=="function"&&(o=t.remoteFilename(n)),r.append(t.uploadFieldName,n,o),typeof t.extraParams=="object")for(u in t.extraParams)t.extraParams.hasOwnProperty(u)&&r.append(u,t.extraParams[u]);if(i.open("POST",t.uploadUrl),typeof t.extraHeaders=="object")for(f in t.extraHeaders)t.extraHeaders.hasOwnProperty(f)&&i.setRequestHeader(f,t.extraHeaders[f]);return i.onload=function(){if(i.status===200||i.status===201)s.onFileUploadResponse(i);else s.onFileUploadError(i)},t.beforeFileUpload(i)!==!1&&i.send(r),i};i.prototype.isFileAllowed=function(n){return n.kind==="string"?!1:this.settings.allowedTypes.indexOf("*")===0?!0:this.settings.allowedTypes.indexOf(n.type)>=0};i.prototype.onFileUploadResponse=function(n){var i,t,r,u;this.settings.onFileUploadResponse.call(this,n)!==!1&&(i=JSON.parse(n.responseText),t=i[this.settings.jsonFieldName],i&&t&&(r=typeof this.settings.urlText=="function"?this.settings.urlText.call(this,t,i):this.settings.urlText.replace(this.filenameTag,t),u=this.editor.getValue().replace(this.lastValue,r),this.editor.setValue(u),this.settings.onFileUploaded.call(this,t)))};i.prototype.onFileUploadError=function(n){if(this.settings.onFileUploadError.call(this,n)!==!1){var t=this.editor.getValue().replace(this.lastValue,"");this.editor.setValue(t)}};i.prototype.onFileInserted=function(n){this.settings.onFileReceived.call(this,n)!==!1&&(this.lastValue=this.settings.progressText,this.editor.insertValue(this.lastValue))};i.prototype.onPaste=function(n){var r=!1,u=n.clipboardData,f,t,i;if(typeof u=="object")for(f=u.items||u.files||[],t=0;t<f.length;t++)if(i=f[t],this.isFileAllowed(i)){r=!0;this.onFileInserted(i.getAsFile());this.uploadFile(i.getAsFile())}return r&&n.preventDefault(),r};i.prototype.onDrop=function(n){for(var t,r=!1,i=0;i<n.dataTransfer.files.length;i++)if(t=n.dataTransfer.files[i],this.isFileAllowed(t)){r=!0;this.onFileInserted(t);this.uploadFile(t)}return r};t.inlineAttachment=i})(document,window);